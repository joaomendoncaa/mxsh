#!/usr/bin/env bash

set -euo pipefail

get_tmux_option() {
	local option="$1"
	local default_value="$2"
	local option_value
	option_value=$(tmux show-option -gqv "$option" 2>/dev/null || echo "")
	if [[ -z "$option_value" ]]; then
		echo "$default_value"
	else
		echo "$option_value"
	fi
}

# @mxsh-path accepts multiple directories separated by ":"
# - "~/path/*"  -> lists all immediate subdirectories of ~/path
# - "~/path"   -> includes ~/path itself as an option
# Example: "~/lab/*:~/.config.jmmm.sh:~/downloads/*"
MXSH_PATH=$(get_tmux_option "@mxsh-path" "$HOME/*")
MXSH_KEY=$(get_tmux_option "@mxsh-key" "s")

sanitize_session_name() {
	local name="$1"
	echo "${name//[:.]/_}"
}

parse_paths() {
	local path_config="$1"
	IFS=':' read -ra PATHS <<<"$path_config"
	local result=()

	for path in "${PATHS[@]}"; do
		[[ -z "$path" ]] && continue
		local is_glob=0
		local base_path

		if [[ "$path" == *"/*" ]]; then
			is_glob=1
			base_path="${path%/\*}"
		else
			base_path="$path"
		fi

		local expanded
		expanded=$(eval echo "$base_path" 2>/dev/null || echo "$base_path")

		if [[ -d "$expanded" ]]; then
			result+=("$path|$expanded|$is_glob")
		fi
	done

	printf '%s\n' "${result[@]}"
}

get_directories_for_path() {
	local path_config="$1"
	local actual_path="$2"
	local is_glob="$3"

	if [[ "$is_glob" == "1" ]]; then
		while IFS= read -r dir; do
			[[ -z "$dir" ]] && continue
			local dirname
			dirname=$(basename "$dir")
			echo "$dirname|$dir"
		done < <(find "$actual_path" -maxdepth 1 -mindepth 1 -type d 2>/dev/null)
	else
		local dirname
		dirname=$(basename "$actual_path")
		echo "$dirname|$actual_path"
	fi
}

get_existing_sessions() {
	local current_session
	current_session=$(tmux display-message -p '#{session_name}' 2>/dev/null || echo "")

	if [[ -z "$current_session" ]]; then
		tmux list-sessions -F '#{session_name}' 2>/dev/null | sort
	else
		tmux list-sessions -F '#{session_name}' 2>/dev/null | grep -v "^${current_session}$" | sort
	fi
}

get_available_directories() {
	local all_dirs=()

	while IFS='|' read -r path_config actual_path is_glob; do
		[[ -z "$path_config" ]] && continue
		local dirs
		dirs=$(get_directories_for_path "$path_config" "$actual_path" "$is_glob")
		while IFS='|' read -r dirname dirpath; do
			[[ -z "$dirname" ]] && continue
			all_dirs+=("$dirname|$dirpath")
		done <<<"$dirs"
	done <<<"$(parse_paths "$MXSH_PATH")"

	printf '%s\n' "${all_dirs[@]}" | sort -t'|' -k1
}

build_selection_list() {
	local existing_sessions
	local all_directories

	existing_sessions=$(get_existing_sessions)
	all_directories=$(get_available_directories)

	if [[ -n "$existing_sessions" ]]; then
		echo "$existing_sessions" | while read -r session; do
			echo -e "* $session\t"
		done
	fi

	if [[ -n "$all_directories" ]]; then
		while IFS='|' read -r dirname dirpath; do
			[[ -z "$dirname" ]] && continue
			if ! echo "$existing_sessions" | grep -qx "$dirname"; then
				echo -e "$dirname\t$dirpath"
			fi
		done <<<"$all_directories"
	fi
}

main() {
	local selection_list
	selection_list=$(build_selection_list)

	if [[ -z "$selection_list" ]]; then
		tmux display-message "No directories found"
		exit 0
	fi

	local selected
	selected=$(echo "$selection_list" | fzf \
		--border=none \
		--layout=default \
		--gutter=" " \
		--prompt "> " \
		--delimiter='\t' \
		--info=hidden \
		--separator=' ' \
		--pointer=' ' \
		--no-color \
		--with-nth=1)

	if [[ -z "$selected" ]]; then
		exit 0
	fi

	local original_session_name
	local target_path

	IFS=$'\t' read -r original_session_name target_path <<<"$selected"

	if [[ "$original_session_name" == "* "* ]]; then
		original_session_name="${original_session_name:2}"
	fi

	if [[ -z "$target_path" ]]; then
		target_path=""
	fi

	local session_name
	session_name=$(sanitize_session_name "$original_session_name")

	# Session exists? switch to it. it doesn't? create it
	if tmux has-session -t="$session_name" 2>/dev/null; then
		if [[ -n "${TMUX:-}" ]]; then
			if ! tmux switch-client -t "$session_name" 2>/dev/null; then
				tmux display-message "Failed to switch to session $original_session_name"
			fi
		else
			if ! tmux attach -t "$session_name" 2>/dev/null; then
				tmux display-message "Failed to attach to session $original_session_name"
			fi
		fi
	else
		if ! tmux new-session -d -s "$session_name" -c "$target_path" 2>&1; then
			tmux display-message "Failed to create session '$original_session_name' (path: '$target_path')"
			exit 1
		fi
		if [[ -n "${TMUX:-}" ]]; then
			if ! tmux switch-client -t "$session_name" 2>/dev/null; then
				tmux display-message "Failed to switch to new session"
			fi
		else
			if ! tmux attach -t "$session_name" 2>/dev/null; then
				tmux display-message "Failed to attach to new session"
			fi
		fi
	fi
}

main "$@"
